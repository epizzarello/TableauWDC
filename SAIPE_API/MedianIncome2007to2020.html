<html>
<head>
    <title>Median Income by State and County 2007-2020</title>
    
    <meta http-equiv="Cache-Control" content="no-store" />

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
    <script>
        (function () {
        var myConnector = tableau.makeConnector();
     
        myConnector.getSchema = function (schemaCallback) {
            var countyCols = [
                { id : "County_Name", alias : "County", dataType : tableau.dataTypeEnum.string },
                { id : "County_Year", alias : "Year (County Inc)", dataType : tableau.dataTypeEnum.int },
                { id : "County_Med_Income", alias : "Median Income (County)", dataType : tableau.dataTypeEnum.float },
                { id : "County_ID", alias : "County ID", dataType : tableau.dataTypeEnum.string },
                { id : "County_State_ID", alias : "State ID (County)", dataType : tableau.dataTypeEnum.string }
            ];

            var countyTableSchema = {
                id : "CountyMedianIncome",
                alias : "County Median Income",
                columns : countyCols
            };
            
            var stateCols = [
                { id : "State_Name", alias : "State", dataType : tableau.dataTypeEnum.string },
                { id : "State_Year", alias : "Year (State Inc)", dataType : tableau.dataTypeEnum.int },
                { id : "State_Med_Income", alias : "Median Income (State)", dataType : tableau.dataTypeEnum.float },
                { id : "State_ID", alias : "State ID (State)", dataType : tableau.dataTypeEnum.string }
            ];
            
            var stateTableSchema = {
                id : "StateMedianIncome",
                alias : "State Median Income",
                columns : stateCols
            };

            schemaCallback([countyTableSchema, stateTableSchema]);
        };
     
        myConnector.getData = function (table, doneCallback) {
            //check if state or county table based on table id
            if (table.tableInfo.id == "StateMedianIncome") {
                $.getJSON("https://api.census.gov/data/timeseries/poverty/saipe?get=NAME,YEAR,SAEMHI_PT&for=state:*&time=from+2007+to+2020", function (respST) {
                    var stateTableData = [];
                    
                    // iterate over state json data array
                    for (let st = 0; st < respST.length; st++) {
                        stateTableData.push({
                            "State_Name" : respST[st].NAME,
                            "State_Year" : parseInt(respST[st].YEAR),
                            "State_Med_Income" : parseFloat(respST[st].SAEMHI_PT),
                            "State_ID" : respST[st].state
                        });
                    }
                    table.appendRows(stateTableData);
                    doneCallback();
                });
            } else if (table.tableInfo.id == "CountyMedianIncome") {
                $.getJSON("https://api.census.gov/data/timeseries/poverty/saipe?get=NAME,YEAR,SAEMHI_PT&for=COUNTY&time=from+2007+to+2020", function (respCT) {
                    var countyTableData = [];
                    
                    // iterate over county level data
                    for (let ct = 0; ct < respCT.length; ct++) {
                        countyTableData.push({
                            "County_Name" : respCT[ct].NAME,
                            "County_Year" : respCT[ct].YEAR,
                            "County_Med_Income" : respCT[ct].SAEMHI_PT,
                            "County_ID" : respCT[ct].county,
                            "County_State_ID" : respCT[ct].state
                        });
                    }
                    table.appendRows(countyTableData);
                    doneCallback();
                });
            };
        };
        tableau.registerConnector(myConnector);
        
        $(document).ready(function () {
            $("#submitButton").click(function () {
                tableau.connectionName = "Median Income by State and County 2007-2020";
                tableau.submit();
            });
        });

    })();

    </script>

</head>
   
<body>
    <div class="container container-table">
        <div class="row vertical-center-row">
            <div class="text-center col-md-4 col-md-offset-4">
                <button type="button" id="submitButton" class="btn btn-success btn-lg" style="margin: 10px;">Get Median Income by State and County 2007-2020</button>
            </div>
        </div>
    </div>
</body>
</html>
