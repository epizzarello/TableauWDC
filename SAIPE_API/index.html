<html>
<head>
    <title>Median Income by State and County 2007-2020</title>
    
    <meta http-equiv="Cache-Control" content="no-store" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>

    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
  <style>
    :invalid {
      border-color:red;
    }
    .invalidMessage {
      display: none;
      color: red;
    }
    #saipe_form > div > div {
      margin-top: .75em;
      margin-bottom: .75em;
    }
    #saipe_form > div#predicates > div > div, #saipe_form > div#predicates > div > center{
      margin: 0;
      padding: 0;
    }
  </style>
    <script>
      $.getJSON('https://api.census.gov/data/timeseries/poverty/saipe/variables.json', function(data) {
          var fields = data.variables;
          var fieldNames = Object.keys(fields);
          fieldNames.sort();
          for (let fieldName of fieldNames) {
            let fieldInfo = fields[fieldName];
            if (fieldInfo.hasOwnProperty("predicateOnly")) {
              //stuff
            } else {
              $("#fieldsSelect").append(`<option value="${fieldName}">${fieldInfo.label}</option>`);
            }
          }
      });
      //populate the states based on the most recent year available
      $.getJSON('https://api.census.gov/data/timeseries/poverty/saipe?get=NAME&for=state:*&time=+from+2020', function(data) {
        let stateName = data[0].indexOf("NAME");
        let stateID = data[0].indexOf("state");
        let dataYear = data[0].indexOf("time");
        let latestYear = data[data.length-1][dataYear];
        $('.year').attr('max',latestYear);
        $('#endYear').val(latestYear);
        $('#maxYear').text(latestYear);
        for (let i = 1; i < data.length; i++) {
          if (data[i][dataYear] == latestYear) {
            $("#refineState").append(`<option class="state" value="${data[i][stateID]}">For ${data[i][stateName]}</option>`);
          }
        };
      });
    </script>
    <script>
        (function () {
        var myConnector = tableau.makeConnector();
     
        myConnector.getSchema = function (schemaCallback) {
            var countyCols = [
                { id : "County_Name", alias : "County", dataType : tableau.dataTypeEnum.string },
                { id : "County_Year", alias : "Year (County Inc)", dataType : tableau.dataTypeEnum.int },
                { id : "County_Med_Income", alias : "Median Income (County)", dataType : tableau.dataTypeEnum.float },
                { id : "County_ID", alias : "County ID", dataType : tableau.dataTypeEnum.string },
                { id : "County_State_ID", alias : "State ID (County)", dataType : tableau.dataTypeEnum.string }
            ];

            var countyTableSchema = {
                id : "CountyMedianIncome",
                alias : "County Median Income",
                columns : countyCols
            };
            
            var stateCols = [
                { id : "State_Name", alias : "State", dataType : tableau.dataTypeEnum.string },
                { id : "State_Year", alias : "Year (State Inc)", dataType : tableau.dataTypeEnum.int },
                { id : "State_Med_Income", alias : "Median Income (State)", dataType : tableau.dataTypeEnum.float },
                { id : "State_ID", alias : "State ID (State)", dataType : tableau.dataTypeEnum.string }
            ];
            
            var stateTableSchema = {
                id : "StateMedianIncome",
                alias : "State Median Income",
                columns : stateCols
            };

            schemaCallback([countyTableSchema, stateTableSchema]);
        };
     
        myConnector.getData = function (table, doneCallback) {
            //check if state or county table based on table id
            if (table.tableInfo.id == "StateMedianIncome") {
                $.getJSON("https://api.census.gov/data/timeseries/poverty/saipe?get=NAME,YEAR,SAEMHI_PT&for=STATE&time=from+2007+to+2020", function (respST) {
                    var stateTableData = [];
                    
                    // iterate over state json data array
                    let stateIndexes = {
                        "NAME":respST[0].indexOf("NAME"),
                        "YEAR":respST[0].indexOf("YEAR"),
                        "SAEMHI_PT":respST[0].indexOf("SAEMHI_PT"),
                        "state":respST[0].indexOf("state")
                    };
                    for (let st = 1; st < respST.length; st++) {
                        stateTableData.push({
                            "State_Name" : respST[st][stateIndexes.NAME],
                            "State_Year" : parseInt(respST[st][stateIndexes.YEAR]),
                            "State_Med_Income" : parseFloat(respST[st][stateIndexes.SAEMHI_PT]),
                            "State_ID" : respST[st][stateIndexes.state]
                        });
                    }
                    table.appendRows(stateTableData);
                    doneCallback();
                });
            } else if (table.tableInfo.id == "CountyMedianIncome") {
                $.getJSON("https://api.census.gov/data/timeseries/poverty/saipe?get=NAME,YEAR,SAEMHI_PT&for=COUNTY&time=from+2007+to+2020", function (respCT) {
                    var countyTableData = [];
                    
                    let countyIndexes = {
                        "NAME":respCT[0].indexOf("NAME"),
                        "YEAR":respCT[0].indexOf("YEAR"),
                        "SAEMHI_PT":respCT[0].indexOf("SAEMHI_PT"),
                        "county":respCT[0].indexOf("county"),
                        "state":respCT[0].indexOf("state")
                    };
                    
                    // iterate over county level data
                    for (let ct = 1; ct < respCT.length; ct++) {
                        countyTableData.push({
                            "County_Name" : respCT[ct][countyIndexes.NAME],
                            "County_Year" : parseInt(respCT[ct][countyIndexes.YEAR]),
                            "County_Med_Income" : parseFloat(respCT[ct][countyIndexes.SAEMHI_PT]),
                            "County_ID" : respCT[ct][countyIndexes.county],
                            "County_State_ID" : respCT[ct][countyIndexes.state]
                        });
                    }
                    table.appendRows(countyTableData);
                    doneCallback();
                });
            };
        };
        tableau.registerConnector(myConnector);
        
        $(document).ready(function () {
          $('input[name="geoLevel"]').change(function () {
            switch($(this).val()) {
              case "us":
                $("#counties").val("");
                $('#allStates').remove();
                $('.state').removeAttr('selected');
                $("#stateRefiner, #countyRefiner").addClass("d-none");
                $('#statesInvalid').hide();
                $('#countiesInvalid').hide();
                break;
              case "state":
                $("#counties").val("");
                $("#stateRefiner").removeClass("d-none");
                $("#countyRefiner").addClass("d-none");
                $('label[for="refineState"]').removeClass('d-none');
                $('#refineState').prop('multiple',true);
                $('#allStates').remove();
                if ($("#refineState").val() == "*" || $("#refineState").val() == null) {
                  $('.state').prop('selected',true);
                }
                $('#countiesInvalid').hide();
                break;
              case "county":
                $("#stateRefiner").removeClass("d-none");
                let prevVal = $("#refineState").val();
                $("#refineState").removeAttr('multiple')
                  .prepend('<option id="allStates" value="*">For All States</option>');
                $('label[for="refineState"]').addClass("d-none");
                if(prevVal == null || prevVal.length > 1) {
                  $("#allStates").prop('selected',true);
                };
                $('#statesInvalid').hide();
                break;
            };
          });
          $("#refineState").change(function () {
            if ($("input[name=geoLevel]:checked").val() == "county") {
              if($("#refineState").val() == "*") {
                $("#counties").val("");
                $("#countyRefiner").addClass("d-none");
              } else {
                $("#countyRefiner").removeClass("d-none");
              };
            };
          });
            $("#submitButton").click(function () {
              //check if valid
              let isValid = true;
              //check to make sure at least one field is selected
              if($('#fieldsSelect').val() == null) {
                isValid = false;
                $('#fieldsInvalid').show();
              } else {
                $('#fieldsInvalid').hide();
              };
              if ($("input[name=geoLevel]:checked").val() == "state" && $('#refineState').val() == null) {
                isValid = false;
                $('#statesInvalid').show();
              } else {
                $('#statesInvalid').hide();
              }
              if($('#counties').is(':invalid')) {
                isValid = false;
                $('#countiesInvalid').show();
              } else {
                $('#countiesInvalid').hide();
              };
              //check if missing one or both years or if outside the accepted range
              if($('.year:invalid').length > 0) {
                isValid = false;
                $('#yearsInvalid').text('Please make sure both years are entered and within the acceptable range.').show();
              } else if ($('#startYear').val() > $('#endYear').val()) {
                isValid = false
                $('#yearsInvalid').text('Your start year cannot be after your end year.').show();
              } else {
                $('#yearsInvalid').text('').hide();
              }
              if (isValid) {
                tableau.connectionName = "Median Income by State and County 2007-2020";
                tableau.submit();
              }
            });
        });

    })();

    </script>

</head>
   
<body>
    <form id="saipe_form" class="container-lg row">
        <div id="fields" class="col-md-6 form-group">Select any fields you would like:<select id="fieldsSelect" class="form-select" multiple size="10" required></select>
          <div id="fieldsInvalid" class="invalidMessage">You must select at least one field.</div>
          <label class="fst-italic" id="refineStateLabel" for="fieldsSelect">Hold down shift to select fields, or CTRL/Command to select each one.</label>
      </div>
      <div id="predicates" class="col-md-6 form-group"><div id="refineTitle">Refine your query:</div>
        <div id="geoLevel">I want data at the 
          <input type="radio" class="btn-check" name="geoLevel" id="us" value="us" checked>
          <label id="usLabel" class="btn btn-outline-primary" for="us">Country Level</label>
          <input type="radio" class="btn-check" name="geoLevel" id="state" value="state">
          <label id="stateLabel" class="btn btn-outline-primary" for="state">State Level</label>
          <input type="radio" class="btn-check" name="geoLevel" id="county" value="county">
          <label id="countyLabel" class="btn btn-outline-primary" for="county">County Level</label>
        </div>
        <div class="md-3 d-none" id="stateRefiner">
          <select multiple class="form-select" id="refineState">
          </select>
          <div id="statesInvalid" class="invalidMessage">You must select at least one state.</div>
          <label class="fst-italic" id="refineStateLabel" for="refineState">Hold down shift to select consecutive states, or CTRL/Command to select each one.</label>
        </div>
        <div class="form-floating d-none" id="countyRefiner">
          <input type="text" id="counties" class="form-control" placeholder="001,003,etc." pattern="^[0-9]{3}(,[0-9]{3})*">
          <label id="countiesLabel" class="" for="counties">List the 3 digit FIPS code of each county you want separated by commas <i>(Optional)</i></label>
          <div id="countiesInvalid" class="invalidMessage">Please use the correct format: 001,003,etc.</div>
        </div>
        <div id="time">
        <center>Time Range</center>
        <div class="input-group">
  		  <span class="input-group-text">From </span>
  		  <input min="1989" value="1989" id="startYear" type="number" class="form-control year" placeholder="Start Year" aria-label="Start Year" required>
          <label id="startYearLabel" class="yearLabel" for="startYear"></label>
  		  <span class="input-group-text"> to </span>
  		  <input min="1989" id="endYear" type="number" class="form-control year" placeholder="End Year" aria-label="End Year" required>
          <label id="endYearLabel" class="yearLabel" for="endYear"></label>
		</div>
        <center id="yearsInvalid" class="invalidMessage"></center>
        <center>SAIPE data is currently available from 1989 to <span id="maxYear"></span></center>
      </div>
      </div>
      <button type="button" id="submitButton" class="btn btn-success btn-lg" style="margin: 10px;">Get SAIPE Data</button>
    </form>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>
